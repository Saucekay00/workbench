<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertifyPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        h1, h2 {
            color: #5532D1;
        }
        .card {
            margin-bottom: 20px;
        }
        .form-control, .btn, select {
            max-width: 500px;
        }
        .btn-primary {
            background-color: #5532D1;
            border-color: #5532D1;
        }
        .btn-primary:hover {
            background-color: #4324a8;
            border-color: #4324a8;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }
        .table th {
            background-color: #e9ecef;
        }
        .section-title {
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #5532D1;
            padding-bottom: 5px;
        }
    </style>
</head>
<body class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center gap-3">
        <img src="/static/logo3.png" alt="Logo" height="60" width="90" style="border-radius: 10px;">
        <h1 class="mb-0">CertifyPro</h1>
      </div>
      <div>
        <p class="mb-1">Welcome, <strong><span id="user-name"></span></strong>!</p>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>


    <div class="card">
        <div class="card-body">
            <h2 class="section-title">Task History</h2>
            <table class="table" id="task-history-table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Participant ID</th>
                        <th>Status</th>
                        <th>Timestamp</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="section-title">Upload Excel File</h2>
            <form id="uploadForm">
                <input type="file" name="file" id="fileUpload" class="form-control mb-3" required>
                <button type="submit" class="btn btn-primary">Upload File</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="section-title">Generate Participant IDs</h2>
            <button id="generateIDs" class="btn btn-primary">Generate IDs</button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="section-title">Generate Certificates</h2>
            <form id="generateCertForm">
                <input type="text" id="programName" placeholder="Enter Program Name" class="form-control mb-3" required>
                <input type="date" id="eventDate" class="form-control mb-3" required>
                <button type="submit" class="btn btn-primary">Generate Certificates</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="section-title">Generate LinkedIn Links</h2>
            <form id="linkGenForm" method="post" action="/linkGen">
                <label for="issueYear">Issue Year:</label>
                <select name="issueYear" id="issueYear" class="form-select mb-3" required>
                    <option value="">Select Year</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>

                <label for="issueMonth">Issue Month:</label>
                <select name="issueMonth" id="issueMonth" class="form-select mb-3" required>
                    <option value="">Select Month</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>

                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="selectAllParticipants">
                    <label class="form-check-label" for="selectAllParticipants">Select All Participants</label>
                </div>

                <div id="participantInputs" class="border p-3 rounded bg-light" style="max-height: 200px; overflow-y: auto;"></div>

                <button type="submit" class="btn btn-primary mt-3">Generate LinkedIn Links</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="section-title">Send Certificates</h2>
            <button id="sendCertificatesBtn" class="btn btn-primary">Send Certificates</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = success ? '#28a745' : '#dc3545';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        document.getElementById('uploadForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData();
            formData.append('file', document.getElementById('fileUpload').files[0]);

            fetch('/upload', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => showToast(data.message || data.error, !!data.message))
                .catch(() => showToast('Error uploading file.', false));
        });

        document.getElementById('generateIDs').addEventListener('click', function () {
            fetch('/idGen', { method: 'POST' })
                .then(response => {
                    if (!response.ok) throw new Error();
                    // We get both the file AND update participant list
                    fetch('/getUserParticipants')  // <-- you’ll create this endpoint
                        .then(res => res.json())
                        .then(data => {
                            const container = document.getElementById('participantInputs');
                            container.innerHTML = '';
                            data.participants.forEach(name => {
                                const label = document.createElement('label');
                                label.innerHTML = `<input type="checkbox" name="participants[]" value="${name}"> ${name}`;
                                container.appendChild(label);
                            });
                        });
                    return response.blob();
                })
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'Generated_Participants.xlsx';
                    link.click();
                    showToast('Participant IDs generated and downloaded!');
                })
                .catch(() => showToast('Error generating participant IDs.', false));
        });

        function populateParticipantCheckboxes(participants) {
            const container = document.getElementById("participantInputs");
            container.innerHTML = ''; // clear old content

            participants.forEach(name => {
                const label = document.createElement("label");
                label.style.display = "block";
                label.innerHTML = `<input type="checkbox" name="participants[]" value="${name}"> ${name}`;
                container.appendChild(label);
            });

            // Attach Select All toggle
            const selectAll = document.getElementById("selectAllParticipants");
            selectAll.checked = false;
            selectAll.addEventListener("change", () => {
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
            });
        }

        fetch('/getUserParticipants')
            .then(res => res.json())
            .then(data => populateParticipantCheckboxes(data.participants));

        document.getElementById("sendCertificatesBtn").addEventListener("click", function () {
            fetch("/sendCertificates", {
                method: "POST"
                // No headers or body needed anymore
            })
            .then(response => response.json())
            .then(data => showToast(data.message || data.error, !!data.message))
            .catch(() => showToast("Failed to send certificates.", false));
        });



        function fetchTaskHistory() {
            fetch('/taskHistory')
                .then(response => response.json())
                .then(data => {
                    const historyBody = document.getElementById('history-body');
                    historyBody.innerHTML = '';

                    if (!data.task_history || data.task_history.length === 0) {
                        historyBody.innerHTML = '<tr><td colspan="5">No tasks found.</td></tr>';  // ✅ Show message if no data
                        return;
                    }

                    data.task_history.forEach(task => {
                        const previewButton = task.participant_id
                            ? `<button onclick="previewCertificate('${task.participant_id}')">Preview</button>`
                            : "N/A";

                        const row = `<tr>
                            <td>${task.task_type}</td>
                            <td>${task.participant_id || 'N/A'}</td>
                            <td>${task.status}</td>
                            <td>${task.timestamp}</td>
                            <td>${previewButton}</td>
                        </tr>`;
                        historyBody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error fetching task history:', error);
                    document.getElementById('history-body').innerHTML = '<tr><td colspan="5">Error loading task history.</td></tr>';
                });
        }


        function previewCertificate(participantId) {
                window.open(`/previewCertificate/${participantId}`, '_blank');
            }

                function logout() {
            fetch('/logout')
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        showToast('Logout failed. Try again.', false);
                    }
                })
                .catch(() => showToast('Error logging out.', false));
        }


        window.onload = function() {
            fetchTaskHistory();
            fetch('/getUser')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('user-name').innerText = data.full_name;
                })
                .catch(error => console.error('Error fetching user:', error));
        };

        document.getElementById('generateCertForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const programName = document.getElementById('programName').value;
            const eventDate = document.getElementById('eventDate').value;

            fetch('/certGen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' //THIS IS ESSENTIAL
                },
                body: JSON.stringify({
                    program_name: programName,
                    event_date: eventDate
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to generate certificates.');
                return response.blob();
            })
            .then(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'Certificates.zip';
                link.click();
                showToast('Certificates generated and downloaded!');
            })
            .catch(() => showToast('Error generating certificates.', false));
        });


        document.getElementById("linkGenForm").addEventListener("submit", function (event) {
            event.preventDefault();

            //Grab selected participant names — update this if you're using checkboxes or a list
            const selectedNames = Array.from(document.querySelectorAll('input[name="participants[]"]:checked')).map(el => el.value);

            const issueYear = document.getElementById("issueYear").value;
            const issueMonth = document.getElementById("issueMonth").value;

            if (!selectedNames.length) {
                showToast("Please select at least one participant.", false);
                return;
            }

            fetch("/linkGen", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    participants: selectedNames,
                    issueYear: issueYear,
                    issueMonth: issueMonth
                })
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to generate links.");
                return response.blob();
            })
            .then(blob => {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "LinkedIn_Links.xlsx";
                link.click();
                showToast("LinkedIn links generated and downloaded!");
            })
            .catch(() => showToast("Error generating LinkedIn links.", false));
        });




    </script>
</body>
</html>
